databaseChangeLog:
  - changeSet:
      id: 1
      author: rails
      preConditions:
        onFail: MARK_RAN
        onError: HALT
        not:
          tableExists:
            tableName: organizations
      changes:
        - sqlFile:
            path: db/migration/V1__init.sql
            relativeToChangelogFile: false
            splitStatements: true
            stripComments: false

  - changeSet:
      id: 2
      author: rails
      comment: "Add organizational hierarchy support with admin-customer relationships and row-level security"
      preConditions:
        onFail: MARK_RAN
        onError: HALT
        not:
          columnExists:
            tableName: users
            columnName: admin_user_id
      changes:
        - sqlFile:
            path: db/migration/V2__organizational_hierarchy.sql
            relativeToChangelogFile: false
            splitStatements: true
            stripComments: false
      rollback:
        - sql: "ALTER TABLE users DROP COLUMN IF EXISTS admin_user_id;"
        - sql: "DROP INDEX IF EXISTS idx_users_admin_customer;"
        - sql: "DROP INDEX IF EXISTS idx_users_org_role;"
        - sql: "ALTER TABLE users DROP CONSTRAINT IF EXISTS chk_customer_has_admin;"
